#include "common.h"
#include "diffops.h"

//g = div(u)
//g is a scalar field and u is a vector field.

void div(Rfield g, const Rfield u, const Real xfactor, const Real yfactor, const Real zfactor)
{

        
        for (Int zi=NGHOST;zi<NZ+NGHOST;zi++)
        {
                for (Int yi=NGHOST;yi<NY+NGHOST;yi++)
                {
                        for (Int xi=NGHOST;xi<NX+NGHOST;xi++)
                        {
                                //compute d_z u_3 at the point (xi,yi,zi)
                                //We sum up the x,y,z-derivatives in this variable and store it at the appropriate point in the scalar field g.
                                
                                Real valAtPoint = zfactor * der1(u[vfidx(xi,yi,zi-2,2)],u[vfidx(xi,yi,zi-1,2)],
                                                                 u[vfidx(xi,yi,zi+1,2)],u[vfidx(xi,yi,zi+2,2)]);
                                
                                //compute d_x u_1 at the point (xi,yi,zi)
                                valAtPoint += xfactor * der1(u[vfidx(xi-2,yi,zi,0)],u[vfidx(xi-1,yi,zi,0)],
                                                             u[vfidx(xi+1,yi,zi,0)],u[vfidx(xi+2,yi,zi,0)]);
                                
                                //compute d_y u_2 at the point (xi,yi,zi)
                                valAtPoint += yfactor * der1(u[vfidx(xi,yi-2,zi,1)],u[vfidx(xi,yi-1,zi,1)],
                                                             u[vfidx(xi,yi+1,zi,1)],u[vfidx(xi,yi+2,zi,1)]);
                                
                                //set g(xi,yi,zi)
                                g[vfidx(xi,yi,zi)] = valAtPoint;
                        }
                }
        }
        
}
